*** Begin Patch
*** Update File: circl-backend/notifications/models.py
@@
 from django.db import models
 from django.contrib.auth import get_user_model
 
 User = get_user_model()
 
 class DeviceToken(models.Model):
-    token = models.CharField(max_length=255, unique=True)
-    user = models.ForeignKey(User, on_delete=models.CASCADE, null=True, blank=True)
-    is_production = models.BooleanField(default=False)  # ✅ NEW
-    created_at = models.DateTimeField(auto_now_add=True)
-
-    def __str__(self):
-        return f"{self.user} - {self.token[:10]}"
+    token = models.CharField(max_length=255, unique=True)
+    user = models.ForeignKey(User, on_delete=models.CASCADE, null=True, blank=True)
+    is_production = models.BooleanField(default=False)  # ✅ NEW
+    created_at = models.DateTimeField(auto_now_add=True)
+
+    # Device metadata
+    device_id = models.CharField(max_length=255, null=True, blank=True)
+    platform = models.CharField(max_length=32, default="ios")
+    app_version = models.CharField(max_length=50, null=True, blank=True)
+    locale = models.CharField(max_length=32, null=True, blank=True)
+    last_seen = models.DateTimeField(auto_now=True)
+    is_active = models.BooleanField(default=True)
+
+    def __str__(self):
+        return f"{self.user} - {self.token[:10]}"
@@
 class Notification(models.Model):
     title = models.CharField(max_length=100, blank=True, null=True)
 
     message = models.TextField()
     sent = models.BooleanField(default=False)
     created_at = models.DateTimeField(auto_now_add=True)
+
+
+# Track notifications that were sent (to avoid duplicates and for auditing)
+class SentNotification(models.Model):
+    user = models.ForeignKey(User, on_delete=models.CASCADE)
+    notification_type = models.CharField(max_length=64)
+    payload = models.JSONField()
+    reference_id = models.IntegerField(null=True, blank=True)
+    sent_at = models.DateTimeField(auto_now_add=True)
+
+    def __str__(self):
+        return f"{self.user} - {self.notification_type} @ {self.sent_at}"
*** End Patch